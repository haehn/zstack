<html>
  <head>
    <title>ZSTACK</title>
    <script type='text/javascript' src='offscreen_renderer.js'></script>
    <script type='text/javascript' src='util.js'></script>
    <script type='text/javascript' src='zlib.min.js'></script>
    <script type='text/javascript'>

    window.onload = function() {


      var _container = document.getElementById('body');

      var _canvas = document.createElement('canvas');
      _canvas.width = _container.clientWidth;
      _canvas.height = _container.clientHeight;
      _container.appendChild(_canvas);

      r = new D.offscreen_renderer(_canvas);
      r.init('vs1', 'fs1');


      width = document.body.clientWidth
      height = document.body.clientHeight
      console.log(width, height)

      width = nearestPOT(width);
      height = nearestPOT(height);
      console.log(width, height)      

      ws = new WebSocket('ws://dragon.krash.net:2001/ws');
      ws.binaryType = 'arraybuffer';

      ws.onmessage = function(msg) {
        
        var data = msg.data;
 
        if (bytes2str(data.slice(0,7)) == "welcome") {
          console.log('Websocket connection established.');


        } else {

          console.log('got image data', data.byteLength)
          var compressed = new Zlib.Inflate(new Uint8Array(data));
          imagedata = compressed.decompress();

          // imagedata = new Uint8Array(data);
          console.log('uncompressed', imagedata.byteLength)
          r.draw(imagedata , width, height);

        }



      }



    };

      function test() {

        for (var i=0; i<10;i++) {
          doit(i);
        }
      }

      function doit(i) {
        var offset_x = i*width;
        var offset_y = i*height;
        get_image([offset_x,offset_x+height,offset_y,offset_y+width],0)
      }

      function get_image(roi, zoomlevel) {

        var out = {};
        out.name = 'GET';
        out.value = [roi, zoomlevel];
        ws.send(JSON.stringify(out))
      }

      function bytes2str(data) {
        return String.fromCharCode.apply(null, new Uint8Array(data));
      }

    </script>
    <script id="fs1" type="x-shader/x-fragment">
      precision mediump float;
      precision mediump int;
      uniform sampler2D uImageSampler;
      varying vec2 vTexturePosition;
      void main() {
        // grab image data
        vec4 image = texture2D(uImageSampler, vTexturePosition);

        gl_FragColor = image;

      }

    </script>  
    <script id="vs1" type="x-shader/x-vertex">
      attribute vec3 aPosition;
      attribute vec2 aTexturePosition;
      varying vec3 vPosition;
      varying vec2 vTexturePosition;
      void main() {
        vTexturePosition = aTexturePosition;
        gl_Position = vec4(aPosition,1.);
      }
    </script>

  </head>
  <body id='body' style='margin:0px;padding:0px;width:100%;height:100%;'>
  </body>
</html>
